name: Build and Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            arch: x64
          - os: windows-latest
            platform: win
            arch: ia32
          - os: macos-latest
            platform: mac
            arch: x64
          - os: macos-latest
            platform: mac
            arch: arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Create placeholder icons
      run: |
        mkdir -p build
        # åˆ›å»ºç®€å•çš„å ä½ç¬¦å›¾æ ‡ï¼ˆä½¿ç”¨ImageMagickæˆ–å…¶ä»–å·¥å…·ï¼‰
        # è¿™é‡Œæˆ‘ä»¬å…ˆåˆ›å»ºç©ºæ–‡ä»¶ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦çœŸæ­£çš„å›¾æ ‡
        touch build/icon.ico
        touch build/icon.png
      shell: bash

    - name: Install dependencies
      run: npm install

    - name: Build application for Windows
      if: matrix.platform == 'win'
      run: npm run build-win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build application for macOS
      if: matrix.platform == 'mac'
      run: npm run build-mac
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å¯¹äºmacOSä»£ç ç­¾åï¼ˆå¯é€‰ï¼‰
        # CSC_LINK: ${{ secrets.MAC_CERTS }}
        # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-${{ matrix.arch }}-build
        path: |
          dist/*.exe
          dist/*.dmg
          dist/*.AppImage
          dist/*.zip
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: ls -la ./artifacts

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: å©´å¹¼å„¿å¥åº·è¿½è¸ªç³»ç»Ÿ ${{ github.event.inputs.version || github.ref_name }}
        body: |
          ## ğŸ¼ å©´å¹¼å„¿å¥åº·è¿½è¸ªç³»ç»Ÿ æ¡Œé¢ç‰ˆ
          
          ### âœ¨ æ–°ç‰¹æ€§
          - åŸºäºWHO 2006æ ‡å‡†çš„ç²¾ç¡®è®¡ç®—
          - æ™ºèƒ½OCRä½“æ£€æŠ¥å‘Šè¯†åˆ«
          - AIä¸ªæ€§åŒ–å–‚å…»å»ºè®®
          - ç”Ÿé•¿æ›²çº¿å¯è§†åŒ–åˆ†æ
          - å®Œå…¨ç¦»çº¿ä½¿ç”¨ï¼Œæ•°æ®æœ¬åœ°å­˜å‚¨
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **Windowsç”¨æˆ·ï¼š**
          - `*.exe` - Windowså®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
          - æ”¯æŒWindows 7åŠä»¥ä¸Šç‰ˆæœ¬
          
          **Macç”¨æˆ·ï¼š**
          - `*.dmg` - macOSå®‰è£…åŒ…
          - æ”¯æŒmacOS 10.13åŠä»¥ä¸Šç‰ˆæœ¬
          - åŒ…å«Intelå’ŒApple Siliconç‰ˆæœ¬
          
          ### ğŸ”§ å®‰è£…æŒ‡å—
          1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. æŒ‰æç¤ºå®Œæˆå®‰è£…
          4. å¯åŠ¨åº”ç”¨å³å¯ä½¿ç”¨
          
          ### ğŸ’¡ ä½¿ç”¨æç¤º
          - é¦–æ¬¡ä½¿ç”¨è¯·å¡«å†™å®å®åŸºæœ¬ä¿¡æ¯
          - æ”¯æŒæ‹–æ‹½ä¸Šä¼ ä½“æ£€æŠ¥å‘Šå›¾ç‰‡
          - æ‰€æœ‰æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼Œç¡®ä¿éšç§å®‰å…¨
          - å¯å¯¼å‡ºæ•°æ®å¤‡ä»½ï¼Œæ”¯æŒæ•°æ®è¿ç§»
          
          ---
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆã€‚
          
        draft: false
        prerelease: false

    - name: Upload Release Assets
      run: |
        for file in ./artifacts/**/*; do
          if [ -f "$file" ]; then
            echo "Uploading $file"
            gh release upload ${{ github.event.inputs.version || github.ref_name }} "$file" --clobber
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
